id: gha-ci
name: CI (Smoke)
type: markdown
content: |-
  name: CI (Smoke)

  on:
    push:
      branches: [ main ]
    pull_request:
      branches: [ main ]

  jobs:
    build-test:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up Micromamba
          uses: mamba-org/setup-micromamba@v1
          with:
            environment-file: environment.yml
            cache-environment: true
            cache-downloads: true

        - name: Install package (editable)
          shell: bash -l {0}
          run: |
            python -m pip install -e .
            pip install pytest pre-commit

        - name: Pre-commit
          shell: bash -l {0}
          run: |
            pre-commit run --all-files || true

        - name: Run unit tests
          shell: bash -l {0}
          run: |
            pytest -q

        - name: Prepare smoke data
          shell: bash -l {0}
          run: |
            mkdir -p data/raw data/interim data/processed results logs
            python - <<'PY'
            import pandas as pd, numpy as np, os
            n=120
            rng=np.random.default_rng(42)
            df=pd.DataFrame({
              "sample_id": [f"S{i:03d}" for i in range(n)],
              "age": rng.integers(20,70,n),
              "sex": rng.choice(["M","F"], n),
              "bmi": rng.normal(27,4,n).round(1),
              "crp": np.clip(rng.normal(3,1.2,n),0.1, None).round(2),
              "batch": rng.integers(1,4,n),
              "addiction_type": rng.choice(["alcohol","opioid","stimulant","cannabis","nicotine","sedative","poly"], n),
              "relapse_3_12m": rng.integers(0,2,n)
            })
            # Fake methylation matrix (28 CpGs + noise)
            cpgs=[f"cg{i:06d}" for i in range(1,61)]
            X=pd.DataFrame(rng.normal(0.5,0.05,(n,len(cpgs))), columns=cpgs)
            X.insert(0,"sample_id", df["sample_id"])
            df.to_csv("data/raw/phenotype.csv", index=False)
            X.to_csv("data/raw/methylation.csv", index=False)
            PY

        - name: Run pipeline (smoke)
          shell: bash -l {0}
          run: |
            python -m epi_clock ingest --config configs/default.yaml
            python -m epi_clock features --config configs/default.yaml
            python -m epi_clock train --config configs/default.yaml --seed 42
            python -m epi_clock evaluate --config configs/default.yaml
            python -m epi_clock make_figures --config configs/default.yaml

        - name: Upload results
          uses: actions/upload-artifact@v4
          with:
            name: results
            path: |
              results/**
              logs/**
